define(["swapp","uiGrid","ui-bootstrap","alert-factory","socket-factory","dialog-module"],function(t){t.registerController("mfLotListController",["$scope","$modal","uiGridConstants","socket","alertFactory","$http","dialogs",function(t,e,n,i,a,o,s){t.permissions=t.$parent.modPermissions,t.pageTranslations=t.$parent.modTranslations,t.exceptions=t.$parent.modExceptions,t.filterParam="filterByOwners";var r="",l="",c="",d="",p="",f="";t.configureGridTemplates=function(){f='<div class="btn-group" dropdown is-open="gridColActionMenu.isDisabled"><button type="button" class="btn dropdown-toggle" dropdown-toggle ng-disabled="gridColActionMenu.isDisabled"><img src="/assets/images/icons/grid-dropdown.png" /></button>',f+='<ul class="dropdown-menu" role="menu">',f+='<li ng-show="getExternalScopes().filterParam() === \'filterByOwners\'"><a ng-click="getExternalScopes().onDropDownActionClick(1,row);">{{getExternalScopes().showChangeOwnerLabel(row)}}</a></li>',f+='<li><a ng-click="getExternalScopes().onDropDownActionClick(2,row);">{{getExternalScopes().getTranslation("mfLotListDeleteUnit")}}</a></li>',f+='<li><a ng-click="getExternalScopes().onDropDownActionClick(3,row);">{{getExternalScopes().getTranslation("mfLotListDivideUnit")}}</a></li>',f+="</ul></div>",p='<div class="ui-grid-cell-contents">{{getExternalScopes().getTranslation(COL_FIELD)}}</div>',r='<div class="status_col ui-grid-cell-contents "><a ng-click="getExternalScopes().openPopUp(row)"><img src="../assets/images/icons/mycommunity.png"></a></div>',l='<div class="status_col ui-grid-cell-contents "><a ng-click="getExternalScopes().onShowUnitDetailsClick(row)">{{COL_FIELD}}</a></div>',d='<div class="status_col ui-grid-cell-contents "><a ng-click="getExternalScopes().onShowContactDetailsClick(row)">{{COL_FIELD}}</a></div>',c='<div class="status_col ui-grid-cell-contents "><a ng-click="getExternalScopes().onShowLevyListClick(row)">{{COL_FIELD}}</a></div>'},t.$on("setModTranslations",function(){t.pageTranslations=t.$parent.modTranslations?t.$parent.modTranslations:t.pageTranslations,t.pageTranslations&&t.configureGrid()}),t.updateGridData=function(e){t.gridOptions.data=[],t.gridOptions.data=e},t.formatDateForDatabase=function(t){if(t instanceof Date){var e=t.getMonth()+1;10>e&&(e="0"+e);var n=t.getDate();return 10>n&&(n="0"+n),t.getFullYear()+"-"+e+"-"+n+" 00:00:00"}var i=new Date(t);return i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate()+" 00:00:00"},t.formatDate=function(t){return t?new Date(t).getTime():t},t.showUnitDetailsPopUp=function(n,i,a){e.open({templateUrl:"/swapp/mfLotList/views/unitDetailsPopup.tpl.html",controller:m,size:"lg",resolve:{windowMode:function(){return n},rowdata:function(){return a},lotDetails:function(){return i},pageTranslations:function(){return t.pageTranslations},parentScope:function(){return t}},backdrop:"static"})},t.confirmDeleteUnit=function(e){var n=t.pageTranslations.mfLotListConfirm+" : "+t.pageTranslations.mfLotListDeleteUnit,i=t.pageTranslations.mfLotListDeleteMsg,a=t.pageTranslations.mfLotListNo,o=t.pageTranslations.mfLotListYes,r=s.confirm(n,i,o,a);r.result.then(function(t){},function(t){})},t.updateOwnerByUnitId=function(t){},t.confirmSubDivideUnit=function(e){var n=t.pageTranslations.mfLotListConfirm+" : "+t.pageTranslations.mfLotListDivideUnit,i=t.pageTranslations.mfLotListSubDivideMsg,a=t.pageTranslations.mfLotListNo,o=t.pageTranslations.mfLotListYes,r=s.confirm(n,i,o,a);r.result.then(function(t){},function(t){})},t.fetchLotListByPropertyId=function(){var e="";e="filterByTenants"===t.filterParam?"Tenant":"Lot Owner";var n={task_request:"Common/getJSONResult",data:{query_name:"getUnitListByNameType",nametype:e,cts:t.$parent.propertySelected.cts}};i.get(n).then(function(e){t.updateGridData(e)})},t.fetchLotListByPropertyId(),t.$on("selectedProperty",function(e,n){t.fetchLotListByPropertyId()}),t.changeGridHeaderName=function(){for(var e=t.gridOptions.columnDefs,i=0;i<e.length;i++)e[i].displayName=t.pageTranslations[e[i].translationKey];t.gridOptions.columnDefs=e,t.gridApi.core.notifyDataChange(t.gridApi.grid,n.dataChange.COLUMN)},t.scopeModel={onShowUnitDetailsClick:function(e){var n={task_request:"Common/getJSONResult",data:{query_name:"getUnitDetails",lot:e.entity.Lot,cts:t.$parent.propertySelected.cts}};i.get(n).then(function(n){t.showUnitDetailsPopUp("editMode",n[0],e)})},onShowContactDetailsClick:function(n){e.open({templateUrl:"/swapp/mfLotList/views/contactDetailsPopup.tpl.html",controller:g,size:"lg",resolve:{rowdata:function(){return n},pageTranslations:function(){return t.pageTranslations},parentScope:function(){return t}},backdrop:"static"})},onShowLevyListClick:function(n){e.open({templateUrl:"/swapp/mfLotList/views/levyListPopup.tpl.html",controller:u,size:"lg",resolve:{rowdata:function(){return n},pageTranslations:function(){return t.pageTranslations},parentScope:function(){return t}},backdrop:"static"})},getTranslation:function(e){return t.pageTranslations[e]},getPermissions:function(e){return t.permissions[e]},decimalFix:function(t){return t>=0?parseFloat(t).toFixed(2):0},onDropDownActionClick:function(e,n){switch(e){case 1:t.updateOwnerByUnitId(n.entity);break;case 2:t.confirmDeleteUnit(n.entity);break;case 3:t.confirmSubDivideUnit(n.entity)}},filterParam:function(){return t.filterParam},showChangeOwnerLabel:function(e){return""===e.entity.name&&""===e.entity.email?t.pageTranslations.mfLotListAddOwner:t.pageTranslations.mfLotListChangeOwner}},t.onAddNewUnitDetails=function(){t.showUnitDetailsPopUp("addMode",{},{})},t.tildeSeparator=function(t){var e=[];if(t)for(var n=t.split(";"),i=0;i<n.length;i++){var a=n[i].split("~");e.push({readable:a[0],value:a[1]})}return e};var m=function(t,e,n,a,o,s,r,l){t.lotDetails=r,t.dateOptions={formatYear:"yy",startingDay:1},t.windowMode=l,t.modalTranslations=a,t.listLotTypes=[],t.listLotTypes=s.tildeSeparator(t.modalTranslations.lottype_list),t.selectedLot=t.listLotTypes[0];for(var c=0;c<t.listLotTypes.length;c++)if(r.type===t.listLotTypes[c].value){t.selectedLot=t.listLotTypes[c];break}t.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],t.format=t.formats[0],t.chargeTypeParam=0===t.lotDetails.levyshare?"singleService":"sharedService",t.dt=s.formatDate(new Date),t.onSaveClick=function(){var n=angular.copy(t.lotDetails);n.type=t.selectedLot.value,n.valuationdate=s.formatDateForDatabase(t.dt),n.levyshare="singleService"===t.chargeTypeParam?0:1,"addMode"===l&&(n.Tennent="",n.TenPhone="",n.OorRforCLAddress=0,n.CLAddressPersonID=0,n.ORA_forLevyAdd=0,n.LevyAddPersonID=0,n.CorrName="",n.LevyName="",n.SubDiv=!1,n.spare=!1,n.ReceiveEMail=!1,n.EMail="",n.lotalpha="",n.bathrooms="",n.gasoutlet="",n.Lot=0,n.CTS=s.$parent.propertySelected.cts),n.query_name="setUnitDetails";var a={task_request:"Common/getJSONResult",data:n};i.get(a).then(function(e){if(0===e.status)o.add("danger",t.modalTranslations.mfLotListEditUnitErrorMsg,5e3);else{if("addMode"===l)n.Lot=e.Lot,s.gridOptions.data.push(n);else{for(var i=0;i<s.gridOptions.data.length;i++)if(s.gridOptions.data[i].Lot===e.Lot){s.gridOptions.data[i]=n;break}s.updateGridData(s.gridOptions.data)}o.add("success",t.modalTranslations.mfLotListEditUnitSuccessMsg,5e3)}}),e.dismiss("cancel")},t.cancel=function(){e.dismiss("cancel")}},g=function(t,e,n,i,a,o){t.dateOptions={formatYear:"yy",startingDay:1},t.modalTranslations=i,t.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],t.format=t.formats[0],"filterByOwners"===o.filterParam?n.entity.inpossesion>0?(t.userRoleType="occupier",t.strUserRole=t.modalTranslations.mfLotListOccupier):(t.userRoleType="owner",t.strUserRole=t.modalTranslations.mfLotListOwner):"filterByTenants"===o.filterParam&&(t.userRoleType="occupier",t.strUserRole=t.modalTranslations.mfLotListOccupier),t.dt=new Date,t.interestTypes=[{name:"Manner1"},{name:"Manner2"},{name:"Manner43"},{name:"Manner55"},{name:"Manner56"},{name:"Manner198"}];t.contactGridData=[{type:"Unit Owner",contact:"Address",address:"John Citizen POBox 6789 Dubai UAE"},{type:"",contact:"Owner 1",address:"Mr Owner 1 Last POBox 6789 Dubai UAE"},{type:"Occupier",contact:"Address",address:"John Citizen POBox 6789 Dubai UAE"}],t.onSaveClick=function(){e.dismiss("cancel")},t.cancel=function(){e.dismiss("cancel")}},u=function(t,e,n,i,a,o){t.modalTranslations=i,t.onSaveClick=function(){e.dismiss("cancel")},t.cancel=function(){e.dismiss("cancel")}};t.gridOptions={},t.configureGrid=function(){t.configureGridTemplates(),t.gridOptions={};var e={useExternalSorting:!0,enableFiltering:!0,enableColumnResizing:!0,paginationPageSizes:[50,100,150,200],paginationPageSize:50,enableGridMenu:!1,exporterCsvFilename:t.pageTranslations.mfLotListHeader+".csv",exporterPdfDefaultStyle:{fontSize:9},exporterPdfTableStyle:{margin:[10,10,10,10]},exporterPdfTableHeaderStyle:{fontSize:10,bold:!0,italics:!0,color:"red"},exporterPdfHeader:{text:t.pageTranslations.mfLotListHeader,style:"headerStyle"},exporterPdfCustomFormatter:function(t){return t.styles.headerStyle={fontSize:22,bold:!0},t.styles.footerStyle={fontSize:10,bold:!0},t},exporterPdfOrientation:"portrait",exporterPdfPageSize:"LETTER",exporterPdfMaxGridWidth:500,columnDefs:[{field:"plan",name:t.pageTranslations.mfLotListPlan,width:"8%",translationKey:"mfLotListPlan",visible:!0},{field:"buildingnumber",name:t.pageTranslations.mfLotListBuilding,width:"8%",translationKey:"mfLotListBuilding",visible:!0},{field:"floor",name:t.pageTranslations.mfLotListFloor,width:"5%",translationKey:"mfLotListFloor",visible:!0},{field:"lotalpha",width:"5%",name:t.pageTranslations.mfLotListLot,translationKey:"mfLotListLot",cellTemplate:l,visible:!0},{field:"Unit",width:"5%",name:t.pageTranslations.mfLotListUnit,translationKey:"mfLotListUnit",cellTemplate:l,visible:!0},{field:"type",name:t.pageTranslations.mfLotListType,translationKey:"mfLotListType",width:"5%",visible:!0},{field:"ContSchedule",name:t.pageTranslations.mfLotListCont,translationKey:"mfLotListCont",cellTemplate:p,width:"5%",visible:!0},{field:"InterSchedule",name:t.pageTranslations.mfLotListInter,translationKey:"mfLotListInter",width:"5%",visible:!0},{field:"name",name:t.pageTranslations.mfLotListName,translationKey:"mfLotListName",width:"10%",cellTemplate:d,visible:!0},{field:"email",name:t.pageTranslations.mfLotListEmail,translationKey:"mfLotListEmail",cellTemplate:d,width:"10%",visible:!0},{field:"levyBalance",name:t.pageTranslations.mfLotListBalance,translationKey:"mfLotListBalance",cellTemplate:c,width:"8%",visible:!0},{field:"ico1",width:"50",name:t.pageTranslations.mfLotListIco1,translationKey:"mfLotListIco1",visible:!0,enableFiltering:!1,cellTemplate:r},{field:"ico2",width:"50",name:t.pageTranslations.mfLotListIco2,translationKey:"mfLotListIco2",visible:!0,enableFiltering:!1,cellTemplate:r},{field:"ico3",width:"50",name:t.pageTranslations.mfLotListIco3,translationKey:"mfLotListIco3",visible:!0,enableFiltering:!1,cellTemplate:r},{field:"ico4",width:"50",name:t.pageTranslations.mfLotListIco4,translationKey:"mfLotListIco4",visible:!0,enableFiltering:!1,cellTemplate:r},{field:"ico5",width:"50",name:t.pageTranslations.mfLotListIco5,translationKey:"mfLotListIco5",visible:!0,enableFiltering:!1,cellTemplate:r},{field:"Action",name:t.pageTranslations.mfLotListAction,translationKey:"mfLotListAction",width:"5%",enableFiltering:!1,cellTemplate:f}]};t.gridOptions=e,t.gridOptions.onRegisterApi=function(e){t.gridApi=e,t.changeGridHeaderName()}},t.pageTranslations&&t.configureGrid(),t.$on("$destroy",function(){t.gridOptions={}}),t.onExportClick=function(e){if("csv"===e){var n=angular.element(document.querySelectorAll(".custom-csv-link-location"));t.gridApi.exporter.csvExport("all","all",n)}else"pdf"===e&&t.gridApi.exporter.pdfExport("all","all")}}])});