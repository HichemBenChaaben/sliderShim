define(["swapp","socket-factory","ui-select","ui-bootstrap","uiGrid","/swapp/directives/address/address-directives.js","/swapp/factories/local-time.js","/swapp/directives/address-book/address-book-picker-directive.js","/swapp/directives/bankpicker/bankpicker-directive.js"],function(e){e.registerController("mfCompDetailsController",["$scope","$rootScope","socket","$filter",function(e,a,t,o){e.selectedInfoSubSection=1,e.objCompanyDetails={contactAddress:{},postalAddress:{}},e.copyObjCompanyDetails={},e.activeCompanyIndex=1,e.tab="details",e.bankDetails={},e.clientId=a.userLoginDetailsVO?a.userLoginDetailsVO.clientId:0,e.exceptions=e.$parent.modExceptions,e.bankPickerOpenStatus={isopen:!1},e.openBankPicker=function(t){t.preventDefault(),t.stopPropagation(),e.objCompanyDetails.isopen||(e.objCompanyDetails.isopen=!0),a.$broadcast("fetchBankPickerData")},e.$on("bankBranchSelected",function(a,t){e.bankDetails.accForm=t.accForm,e.objCompanyDetails.bankaccountdetails.l_account_name=t.Bank,e.objCompanyDetails.bankaccountdetails.l_account_bsb=t.BSB||t.swift,e.BankDetails_by_BSB(e.objCompanyDetails.bankaccountdetails.l_account_bsb),e.showBankAccInfo=!0,e.objCompanyDetails.isopen=!1}),e.validateBankAcc=function(){if(e.bankDetails.accForm)var a=e.bankDetails.accForm.split(",");var t=e.objCompanyDetails.bankaccountdetails.l_account_number.replace(/\d/g,"#");a&&!_.includes(a,t)&&(e.form.l_account_number.$valid=!1,e.form.l_account_number.$invalid=!0,e.form.$invalid=!0)},e.datePickerOptions={formatYear:"yy",startingDay:1},e.dateFormat=e.$parent.localTimeFormat,e.permissions=e.$parent.modPermissions,e.pageTranslations=e.$parent.modTranslations,e.$on("setModTranslations",function(a){e.permissions=e.$parent.modPermissions,e.exceptions=e.$parent.modExceptions,e.pageTranslations=e.$parent.modTranslations}),e.formatDate=function(e){return e?new Date(e).getTime():e},e.formatDateForDatabase=function(e){if(e instanceof Date){var a=e.getMonth()+1;10>a&&(a="0"+a);var t=e.getDate();return 10>t&&(t="0"+t),e.getFullYear()+"-"+a+"-"+t+" 00:00:00"}var o=new Date(e);return o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+" 00:00:00"},e.updateDetailsObject=function(a){e.objCompanyDetails=angular.copy(a),e.objCompanyDetails.l_insuramount=parseInt(e.objCompanyDetails.l_insuramount),e.objCompanyDetails.contactAddress={},e.objCompanyDetails.postalAddress={},e.objCompanyDetails.contactAddress.Suburb=e.objCompanyDetails.l_location,e.objCompanyDetails.contactAddress.Postcode=e.objCompanyDetails.l_postcode,e.objCompanyDetails.postalAddress.Suburb=e.objCompanyDetails.l_postal_location,e.objCompanyDetails.postalAddress.Postcode=e.objCompanyDetails.l_postal_postcode,e.copyObjCompanyDetails=angular.copy(e.objCompanyDetails)},e.saveDetailsToDatabase=function(a,o){var n={task_request:"Company/setDetails",data:e.$parent.unformatDate(a)};t.get(n).then(function(a){if("1"===a.value){switch(o){case"contactDetails":for(var t=e.objCompanyDetails.phonenos.length,n=0;t>n;n++)e.objCompanyDetails.phonenos[n].status="R";break;case"insuranceDetails":e.updateDetailsObject(e.objCompanyDetails)}e.$parent.addAlert("SUCCESS","SUCCESS")}else e.$parent.addAlert("ERROR","ERROR")})};var n={};n.client_id=e.clientId;var s={task_request:"Company/getDetails",data:n};t.get(s).then(function(a){a=e.$parent.formatDate(a),e.updateDetailsObject(a)});var i={task_request:"Contact/getPhoneTypes",data:""};t.get(i).then(function(a){e.$parent.formatDate(a),e.phoneTypeList=[];for(var t=0;t<a.length;t++)e.phoneTypeList.push({phonetype:a[t],id:t+1});if(e.objCompanyDetails.phonenos)for(var t=0;t<e.objCompanyDetails.phonenos.length;t++)e.objCompanyDetails.phonenos[t].dataSource=angular.copy(e.phoneTypeList),e.objCompanyDetails.phonenos[t].preferredString=1===e.objCompanyDetails.phonenos[t].preferred?"true":"false";var o=e.userPhoneGridOptions.columnDefs,n={name:"phonetype",displayName:"Phone Type 2",editableCellTemplate:"ui-grid/dropdownEditor",enableCellEditOnFocus:!0,editDropdownIdLabel:"phonetype",editDropdownValueLabel:"phonetype",editDropdownOptionsArray:e.phoneTypeList};o.splice(0,0,n),e.userPhoneGridOptions.columnDefs=o,e.userPhoneGridOptions.data=[],e.userPhoneGridOptions.data=e.objCompanyDetails.phonenos}),e.saveContactDetails=function(){var a={};a.l_update="contact",a.l_clientid=e.objCompanyDetails.l_clientid,a.l_name=e.objCompanyDetails.l_name,a.l_abnacn=e.objCompanyDetails.l_abnacn,a.l_registrationdate=e.formatDateForDatabase(e.objCompanyDetails.l_registrationdate),a.l_compname=e.objCompanyDetails.l_compname,a.l_address=e.objCompanyDetails.l_address,a.l_location=e.objCompanyDetails.contactAddress.Suburb,a.l_postcode=e.objCompanyDetails.contactAddress.Postcode,a.l_postal_address=e.objCompanyDetails.l_postal_address,a.l_postal_location=e.objCompanyDetails.postalAddress.Suburb,a.l_postal_postcode=e.objCompanyDetails.postalAddress.Postcode,a.l_email=e.objCompanyDetails.l_email,a.l_www=e.objCompanyDetails.l_www,a.l_bdm=e.objCompanyDetails.l_bdm,a.l_addresses_recordid=e.objCompanyDetails.l_addresses_recordid,a.l_phonelist=[];for(var t=0;t<e.objCompanyDetails.phonenos.length;t++)a.l_phonelist.push({phone:e.objCompanyDetails.phonenos[t].phone,phoneid:e.objCompanyDetails.phonenos[t].phoneid,phonetype:e.objCompanyDetails.phonenos[t].phonetype,preferred:e.objCompanyDetails.phonenos[t].preferred,status:e.objCompanyDetails.phonenos[t].status});e.saveDetailsToDatabase(a,"contactDetails")},e.addNewContactPhoneType=function(){var a={};return a.dataSource=e.phoneTypeList,a.phone="",a.phonetype="",a.phoneid="",a.preferred=0,a.status="C",a.preferredString=1===a.preferred?!0:!1,e.objCompanyDetails.phonenos.push(a),e.userPhoneGridOptions.data=e.objCompanyDetails.phonenos,e.objCompanyDetails.phonenos},e.updatePhoneTypeStatus=function(a,t){for(var o=0;o<e.copyObjCompanyDetails.phonenos.length;o++)if(a.phoneid===e.copyObjCompanyDetails.phonenos[o].phoneid){e.copyObjCompanyDetails.phonenos[o].status="D";break}},e.initUserPhonetypeGrid=function(){e.scopeGridModel={deleteContactNumber:function(a){var t=e.objCompanyDetails.phonenos.indexOf(a.entity);e.objCompanyDetails.phonenos.splice(t,1),e.updatePhoneTypeStatus(a.entity,"D")},rowHover:function(e){e.isSelected=!e.isSelected}};var a='<div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" ng-mouseenter="getExternalScopes().rowHover(row)"  ng-mouseleave="getExternalScopes().rowHover(row)" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',t='<div class="ui-grid-cell-contents"><button><i class="glyphicon glyphicon-trash" ng-click="getExternalScopes().deleteContactNumber(row);"></i></button></div>';if(e.phoneTypeList=[],e.userPhoneGridOptions={enableFiltering:!1,rowTemplate:a,enableColumnMenus:!1,columnDefs:[{field:"phone",displayName:o("translate")("Number"),width:"25%",enableCellEditOnFocus:!0},{field:"preferredString",displayName:o("translate")("Preferred"),width:"25%",type:"boolean",enableCellEditOnFocus:!0}]},e.permissions.isDeleteAllowed){var n={field:"phoneid",name:"",width:50,cellTemplate:t,enableCellEdit:!1};e.userPhoneGridOptions.columnDefs.push(n)}e.userPhoneGridOptions.data=[],e.userPhoneGridOptions.onRegisterApi=function(a){e.gridApi=a,a.edit.on.afterCellEdit(e,function(a,t,o,n){"phonetype"===t.name?a.phonetype=o:"preferredString"===t.name&&(a.preferred="true"===o?1:0),e.updatePhoneTypeStatus(a,"U")})}},e.initUserPhonetypeGrid(),e.BankDetails_by_BSB=function(a){if(a){var o={task_request:"Bank/getDetails",data:{bsb:a}};return t.get(o).then(function(a){a=e.$parent.formatDate(a),e.strBankName=a.l_bankname,e.strAccSample=a.l_accsample,e.objCompanyDetails.l_account_format=a.l_accsample})}return""},e.populateBankDetails=function(){e.objCompanyDetails.bankaccountdetails&&e.objCompanyDetails.bankaccountdetails.l_account_bsb&&(e.BankDetails_by_BSB(e.objCompanyDetails.bankaccountdetails.l_account_bsb),e.showBankAccInfo=!0)},e.saveBankAccountDetails=function(){var a={};a.l_update="bank",a.l_account_name=e.objCompanyDetails.bankaccountdetails.l_account_name,a.l_account_bsb=e.objCompanyDetails.bankaccountdetails.l_account_bsb,a.l_account_number=e.objCompanyDetails.bankaccountdetails.l_account_number,a.l_bdm=e.objCompanyDetails.l_bdm,a.l_clientid=e.objCompanyDetails.l_clientid,e.saveDetailsToDatabase(a,"bankDetails")},e.populateInsuranceDetails=function(){e.insurerAddressList={},e.objCompanyDetails.l_insur_d={},e.insurerAddressList=[{recordid:"",escro:0,cname:e.objCompanyDetails.l_insur}],e.objCompanyDetails.l_insur_d.selected=e.insurerAddressList[0],e.objCompanyDetails.l_broker_d={},e.insuranceBrokerAddressList=[{recordid:"",escro:0,cname:e.objCompanyDetails.l_broker}],e.objCompanyDetails.l_broker_d.selected=e.insuranceBrokerAddressList[0]},e.onDateChange=function(a,t){if(a){var o=a.getFullYear(),n=a.getMonth()+1,s=a.getDate();10>n&&(n="0"+n),10>s&&(s="0"+s);var i=o+"-"+n+"-"+s;e.objCompanyDetails[t]=i}},e.onDatePopupOpen=function(e){e.preventDefault(),e.stopPropagation()};var i={task_request:"Contractor/getInsuranceLists",data:""};t.get(i).then(function(a){e.$parent.formatDate(a),e.insurerAddressList=a.insurance_company_list,e.insuranceBrokerAddressList=a.insurance_broker_list}),e.updateInsuranceItem=function(a,t){e.objCompanyDetails.l_insur=a.cname,e.insurerAddressList=[{cname:a.cname}]},e.updateInsuranceBrokerItem=function(a,t){e.objCompanyDetails.l_broker=a.cname,e.insuranceBrokerAddressList=[{cname:a.cname}]},e.saveInsuranceDetails=function(){var a={};a.l_update="insurance",a.l_clientid=e.objCompanyDetails.l_clientid,a.l_insur=e.objCompanyDetails.l_insur,a.l_broker=e.objCompanyDetails.l_broker,a.l_insuramount=parseInt(e.objCompanyDetails.l_insuramount,10),a.l_insurfrom=e.formatDateForDatabase(e.objCompanyDetails.l_insurfrom),a.l_insurto=e.formatDateForDatabase(e.objCompanyDetails.l_insurto),e.saveDetailsToDatabase(a,"insuranceDetails")},e.populateMembershipDetails=function(){var a="";e.objCompanyDetails.l_membership2="",e.objCompanyDetails.l_membership1&&(a=e.objCompanyDetails.l_membership1.toLowerCase()),e.objCompanyDetails.l_membership1=a},e.saveMembershipDetails=function(){var a={};a.l_update="membership",a.l_clientid=e.objCompanyDetails.l_clientid,a.l_membership1=e.objCompanyDetails.l_membership1,a.l_membership2="",e.saveDetailsToDatabase(a,"membershipDetails")},e.saveNotesDetails=function(){var a={};a.l_update="notes",a.l_notes=e.objCompanyDetails.l_notes,a.l_bdm=e.objCompanyDetails.l_bdm,a.l_clientid=e.objCompanyDetails.l_clientid,e.saveDetailsToDatabase(a,"notes")},e.populateBankDetails(),e.populateInsuranceDetails(),e.populateMembershipDetails(),e.addressPickerOpenStatus={isopen:!1},e.toggleDropdown=function(t){t.preventDefault(),t.stopPropagation(),e.addressPickerOpenStatus.isopen||(e.addressPickerOpenStatus.isopen=!e.addressPickerOpenStatus.isopen),a.$broadcast("fetchAddressBookPickerData",e.addressBookConfig)},e.$on("addressKeySet",function(t,o){e.objCompanyDetails.l_compname=o.cname,e.objCompanyDetails.l_address=o.StAddress,e.objCompanyDetails.Suburb=o.Suburb,e.objCompanyDetails.Postcode=o.Postcode,e.addressPickerOpenStatus.isopen=!e.addressPickerOpenStatus.isopen,a.$broadcast("updateAddress",{uniqueId:"ctcAddress",locality:o.Suburb,pc:o.Postcode})}),e.addressBookConfig={cts:e.$parent.propertySelected.cts,clientId:a.userLoginDetailsVO.clientId,defaultContactType:"",defaultIndustryType:"",permissions:{isAddAllowed:!0,isEditContactTypeAllowed:!0,isEditIndustryTypeAllowed:!0}}}])});