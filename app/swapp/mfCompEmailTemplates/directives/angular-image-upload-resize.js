angular.module("imageupload",[]).directive("image",["$q",function(e){"use strict";var t=window.URL,i=function(){var e="fileupload-resize-area",t=document.getElementById(e);return t||(t=document.createElement("canvas"),t.id=e,t.style.visibility="hidden",document.body.appendChild(t)),t},n=function(e,t){var n=t.resizeMaxHeight||300,r=t.resizeMaxWidth||250,a=t.resizeQuality||.7,o=t.resizeType||"image/jpg",s=i(),l=e.height,u=e.width;u>l?u>r&&(l=Math.round(l*=r/u),u=r):l>n&&(u=Math.round(u*=n/l),l=n),s.width=u,s.height=l;var c=s.getContext("2d");return c.drawImage(e,0,0,u,l),t.counterFileLength>0&&t.counterFileLength--,s.toDataURL(o,a)},r=function(e,t){var i=new Image;i.onload=function(){t(i)},i.src=e},a=function(t){var i=e.defer(),n=new FileReader;return n.onload=function(e){i.resolve(e.target.result)},n.readAsDataURL(t),i.promise};return{restrict:"A",scope:{image:"=",resizeMaxHeight:"=",resizeMaxWidth:"=",resizeQuality:"@?",resizeType:"@?",showProcessing:"=",showError:"=",totalImagesAllowed:"="},link:function(e,i,o,s){var l=function(t,i){c(!0),r(t.url,function(r){var a=n(r,e);t.resized={dataURL:a,type:a.match(/:(.+\/.+);/)[1]},i(t)})},u=function(t){e.$apply(function(){0==e.counterFileLength&&(e.showProcessing=!1),o.multiple?e.image.push(t):e.image=t})},c=function(t){e.$apply(function(){e.showProcessing=t})};i.bind("change",function(i){e.showError=!1,o.multiple&&(e.image=[]);var n=i.target.files;if(e.counterFileLength=n.length,e.totalImagesAllowed<e.counterFileLength)e.image=[],e.showError=!0,e.showProcessing=!1,i.target.files=[],e.$apply();else for(var r=0;r<n.length;r++){var s={file:n[r],url:t.createObjectURL(n[r])};a(n[r]).then(function(e){s.dataURL=e}),e.resizeMaxHeight||e.resizeMaxWidth?l(s,function(e){u(e)}):u(s)}})}}}]);