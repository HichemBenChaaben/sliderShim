define(["swapp","alert-factory","socket-factory","angular-wysiwyg","ui-bootstrap","ng-imageUploadResize","ng-LoadingBusy"],function(a){a.registerController("mfCompEmailTemplatesController",["$scope","$state","$rootScope","alertFactory","socket","$modal",function(a,e,t,r,i,l){a.permissions=a.$parent.modPermissions,a.pageTranslations=a.$parent.modTranslations,a.originalTemplateData={},a.currTemplateData={};var m=/<img\s.*?>/g;a.items=[],a.mergefields=[],a.emailTypeString="",a.selectedEmailType=1,a.activeEmail=1;var n=0,c=10;a.embedImagesInHTML=function(a,e){for(var t=0;t<e.length;t++)a.search("cid:im"+e[t].cid)>-1&&(a=a.replace("cid:im"+e[t].cid,"data:image/png;base64,"+e[t].imgdata));return a},a.updateTotalImageCount=function(a,e){var t=a.match(e);return t?t.length:0},a.populateTemplateData=function(e){var t=/(\&lt\;\&lt\;[^>]*?\&gt\;\&gt\;)(?!<\/span>)/i,r="";return a.currTemplateData=angular.copy(e),a.currTemplateData.emailHTML=a.currTemplateData.emailbody,r=a.currTemplateData.emailHTML.match(t),a.currTemplateData.body_cid_array=a.isFormattedArray(a.currTemplateData.body_cid_array),a.currTemplateData.body_cid_count=a.currTemplateData.body_cid_array.length,a.currTemplateData.sign_cid_array=a.isFormattedArray(a.currTemplateData.sign_cid_array),a.currTemplateData.sign_cid_count=a.currTemplateData.sign_cid_array.length,r&&(a.currTemplateData.emailHTML=a.currTemplateData.emailHTML.replace(r[1],'<span contenteditable="false">'+r[1]+"</span>")),a.currTemplateData.body_cid_array.length&&(a.currTemplateData.emailHTML=a.embedImagesInHTML(a.currTemplateData.emailHTML,a.currTemplateData.body_cid_array)),a.currTemplateData.sign_cid_array.length&&(a.currTemplateData.emailHTML=a.embedImagesInHTML(a.currTemplateData.emailHTML,a.currTemplateData.sign_cid_array)),a.currTemplateData.obsolete_cids=[],a.originalTemplateData=angular.copy(a.currTemplateData),n=a.updateTotalImageCount(a.currTemplateData.emailHTML,m),a.currTemplateData},a.getEmailTemplateOnLoad=function(e){var t={task_request:"Company/getEmailTemplate",data:{template_type:e}};i.get(t).then(function(e){e=angular.fromJson(e),a.populateTemplateData(e)})},a.getEmailTemplateOnLoad(1),a.getMergeFields=function(){var e={task_request:"Contact/getEmailMergeField",data:{template_type:a.selectedEmailType}};i.get(e).then(function(e){e=angular.fromJson(e),a.mergefields=e})},a.getMergeFields(),a.onEmailTypeClick=function(e){switch(a.activeEmail=e,e){case 1:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesServiceChargeEmail;break;case 2:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesArrearsEmail;break;case 3:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesCorrespondenceEmail;break;case 4:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesMeetingEmail;break;case 5:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesBatchEmail;break;case 6:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesGenericEmail;break;case 7:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesRequestforQuote;break;case 8:a.emailTypeString=a.pageTranslations.mfCompEmailTemplatesWorkorder}e>0&&(a.selectedEmailType=e,a.getEmailTemplateOnLoad(e))},a.isFormattedArray=function(a){if(a){if(Array.isArray(a))return a;if(a.length<4)return[];var e=JSON.parse("["+a+"]");if(Array.isArray(e[0]))return e[0];var t=[];return t.push(e[0]),t}return[]},a.onResetEmailTemplate=function(){a.currTemplateData.emailHTML=a.originalTemplateData.emailHTML},a.replaceOldBase64sWithCids=function(e){var t=e.match(/<(img src="data:image\/png;base64,).+?>/g),r=0,i="",l="",m="",n=[];return angular.forEach(t,function(t){if(m="",n=t.split('src="data:image/png;base64,'),n[1])for(m=n[1].substring(0,n[1].indexOf('"')),r=0;r<a.currTemplateData.body_cid_array.length;r++)m===a.currTemplateData.body_cid_array[r].imgdata&&(i='src="cid:im'+a.currTemplateData.body_cid_array[r].cid+'" ',l=t.replace(t.match(/(src=").+?"/g),i),e=e.replace(t,l))}),e},a.setEmailTemplate=function(e){var t={},l="";null===e?(t.body_cid_array=a.currTemplateData.body_cid_array,t.body_cid_count=a.currTemplateData.body_cid_array.length,t.emailbody=a.currTemplateData.emailHTML):(t.body_cid_array=0!==a.currTemplateData.body_cid_array.length?a.currTemplateData.body_cid_array.concat(e.imgArray):e.imgArray,t.body_cid_count=e.imgArray.length,t.emailbody=e.emailBody),l=t.emailbody.match(m),l?t.emailbody=a.replaceOldBase64sWithCids(t.emailbody):(t.body_cid_array=[],t.body_cid_count=0),a.currTemplateData.obsolete_cids&&(t.obsolete_cids=a.currTemplateData.obsolete_cids),t.emailaddress=a.currTemplateData.emailaddress,t.emailsig=a.currTemplateData.emailsig,t.sign_cid_array=a.currTemplateData.sign_cid_array,t.sign_cid_count=a.currTemplateData.sign_cid_count,t.type=a.currTemplateData.type,t.use_staff_signature=a.currTemplateData.use_staff_signature,t.usestaffemail=a.currTemplateData.usestaffemail;var n={task_request:"Company/setEmailTemplate",data:t};return i.get(n).then(function(e){1===e?(r.add("success",a.pageTranslations.mfCompEmailTemplatesEmailTemplateSaved,5e3),a.populateTemplateData(t)):r.add("danger",a.pageTranslations.mfCompEmailTemplatesEmailTemplateErrorMsg,5e3)})},a.mergeNewCIDs=function(e){var t=a.currTemplateData.emailHTML,r=[],i=t.match(m),l=0;e=a.isFormattedArray(e),angular.forEach(i,function(i){for(var m={},n="",c="",o=[],s=!1,p=0;p<a.originalTemplateData.body_cid_array.length;p++)if(o=i.split('src="data:image/png;base64,'),n=o[1].substring(0,o[1].indexOf('"')),a.originalTemplateData.body_cid_array[p].imgdata===n){s=!0;break}s?(m={cid:a.originalTemplateData.body_cid_array[p].cid,imgdata:a.originalTemplateData.body_cid_array[p].imgdata},c='src="cid:im'+a.originalTemplateData.body_cid_array[p].cid+'" ',o=i.split('src="data:image/png;base64,')):(c='src="cid:im'+e[l]+'" ',o=i.split('src="data:image/png;base64,'),n=o[1].substring(0,o[1].indexOf('"')),m={cid:e[l],imgdata:n}),imgTag=i.replace(i.match(/(src=").+?"/g),c),t=t.replace(i,imgTag),r.push(m),m=null,l++});var n={imgArray:r,emailBody:t};return n},a.countDiffBase64s=function(e){var t="",r=[],i=0,l=0,m=0,n=[],c=!1;for(i=0;i<a.currTemplateData.body_cid_array.length;i++)a.currTemplateData.body_cid_array[i].imgStatus="old";for(i=0;i<e.length;i++)if(r=e[i].split('src="data:image/png;base64,'),r[1]){for(t=r[1].substring(0,r[1].indexOf('"')),c=!1,l=0;l<a.currTemplateData.body_cid_array.length;l++)if(t===a.currTemplateData.body_cid_array[l].imgdata){c=!0,"old"===a.currTemplateData.body_cid_array[l].imgStatus&&(a.currTemplateData.body_cid_array[l].imgStatus="existing");break}c||m++}var o=[];for(i=0;i<a.currTemplateData.body_cid_array.length;i++)"old"===a.currTemplateData.body_cid_array[i].imgStatus&&(o.push(a.currTemplateData.body_cid_array[i]),n.push(a.currTemplateData.body_cid_array[i].cid));a.currTemplateData.body_cid_array=o;var s={countNew:m,obsoleteImages:n};return s},a.checkObsoleteImages=function(e){var t={};t.imgCount=0,t.shouldFetchImages=!1;var r=e.match(m);if(r){if(0===a.currTemplateData.body_cid_count)t.imgCount=r.length,t.shouldFetchImages=!0;else{var i=a.countDiffBase64s(r);i.obsoleteImages.length>0&&(a.currTemplateData.obsolete_cids=i.obsoleteImages),t.imgCount=i.countNew,t.shouldFetchImages=t.imgCount>0?!0:!1}return t}if(0!==a.currTemplateData.body_cid_count){for(var l=[],n=0;n<a.currTemplateData.body_cid_array;n++)l.push(a.currTemplateData.body_cid_array[n].cid);a.currTemplateData.obsolete_cids=l}return t.imgCount=0,t.shouldFetchImages=!1,t},a.onSaveEmailTemplate=function(){if(n=a.updateTotalImageCount(a.currTemplateData.emailHTML,m),n>=c)r.add("danger",a.pageTranslations.mfCompEmailTemplatesImageCountError+c,5e3);else{var e=a.currTemplateData.emailHTML,t=a.checkObsoleteImages(e);if(t.shouldFetchImages){var l={task_request:"Company/getNewImageCIDs",data:{new_cid_count:t.imgCount}};i.get(l).then(function(e){if(0!==e.length){var t=a.mergeNewCIDs(e);a.setEmailTemplate(t)}})}else a.setEmailTemplate(null)}},a.onTemplateEditorClick=function(e){a.currSelection={},a.currSelection.window=window,a.currSelection.currentRange=window.getSelection().getRangeAt(0),n=a.updateTotalImageCount(a.currTemplateData.emailHTML,m)},a.getNodeToInsert=function(e){if(window.getSelection){var t,r;return a.currSelection.currentRange?(a.currSelection.currentRange.collapse(!1),t=document.createElement("p"),t.innerHTML=e,r=document.createDocumentFragment(),r.appendChild(t.firstChild),r):null}return null},a.onMergeFieldClick=function(e){e=e.replace("<<","&lt;&lt;"),e=e.replace(">>","&gt;&gt;"),e='<span contenteditable="false">'+e+"</span>";var t=a.getNodeToInsert(e);return a.currSelection.currentRange&&a.currSelection.currentRange.insertNode(t),t},a.onImageClick=function(e){if(n=a.updateTotalImageCount(a.currTemplateData.emailHTML,m),n>=c)r.add("danger",a.pageTranslations.mfCompEmailTemplatesImageCountError+c,5e3);else{var t=window.getComputedStyle(document.getElementById("question"));l.open({templateUrl:"/swapp/mfCompEmailTemplates/views/imageUploadPopUp.tpl.html",controller:o,size:"lg",resolve:{items:function(){return a.documentListArray},numImages:function(){return n},maxImages:function(){return c},sizeObject:function(){var a=t.height.substring(0,t.height.length-2),e=parseInt(a)-50,r=t.width.substring(0,t.width.length-2),i=parseInt(r)-50;return i=i>600?600:i,e=e>338?338:e,{computedMaxHeight:e,computedMaxWidth:i}},parentScope:function(){return a}},backdrop:"static"})}};var o=function(a,e,t,r,i,l,m,n,c){a.items=t,a.computedMaxHeight=r.computedMaxHeight,a.computedMaxWidth=r.computedMaxWidth,a.showWait=!1,a.showLimitExceedError=!1,a.pageTranslations=l.pageTranslations,a.countImages=n-c,a.limitExceedErrorMessage=a.pageTranslations.mfCompEmailTemplatesImageCountError+a.countImages,a.delay=0,a.minDuration=0,a.message=a.pageTranslations.mfCompEmailTemplatesImageProcessingMsg,a.backdrop=!0,a.promise=null,a.$watch("showWait",function(){a.showWait===!0?a.promise=m(function(){},2e6):a.showWait===!1&&(a.promise=null)}),a.onAddTemplateClick=function(){var t=l.currTemplateData.emailHTML,r="<br><br>",i=t.search(/<\/body>/);-1===i&&(i=t.search(/<\/div>/));for(var m=0;m<a.uploadedImages.length;m++)r=r+'<p><img src="'+a.uploadedImages[m].resized.dataURL+'" alt="" />';t=t.substring(0,i)+r+t.substring(i,t.length),l.currTemplateData.emailHTML=t,l.currTemplateData.uploadedNewImages=a.uploadedImages,e.close()},a.onPopUpCancel=function(){e.dismiss("cancel")}}}])});