define(["swapp","uiGrid","ui-bootstrap","/swapp/mfAccessLedger/services/mfAccessLedgerService.js","http://ui-grid.info/docs/grunt-scripts/csv.js","http://ui-grid.info/docs/grunt-scripts/pdfmake.js","http://ui-grid.info/docs/grunt-scripts/vfs_fonts.js","alert-factory"],function(e){e.registerController("mfAccessLedgerController",["$scope","socket","mfAccessLedgerService","alertFactory","uiGridConstants","$log",function(e,t,s,n,i,o){function a(s){s.entity.checkOutStatus=1,clickedDisconnect=!0;var i={task_request:"Session/killSession",data:{session_key:s.entity.sessionKey}};t.get(i).then(function(t){t=angular.fromJson(t),s.entity.checkOutDate=t.checkOutDate,s.entity.checkOutTime=t.checkOutTime,n.add("success",e.pageTranslations.mfAccessLedgerUserDisconnected,5e3)})}e.$on("setModTranslations",function(){e.pageTranslations=e.$parent.modTranslations?e.$parent.modTranslations:e.pageTranslations,e.changeGridHeaderName()}),e.objAccessHistory={},e.clickedDisconnect=!0,e.tomorrow=new Date((new Date).getTime()+864e5),e.permissions=e.$parent.modPermissions,e.pageTranslations=e.$parent.modTranslations?e.$parent.modTranslations:e.pageTranslations,e.exceptions=e.$parent.modExceptions,e.changeGridHeaderName=function(){for(var t=e.gridOptions.columnDefs,s=0;s<t.length;s++)t[s].displayName=e.pageTranslations[t[s].translationKey];e.gridOptions.columnDefs=t,e.gridApi.core.notifyDataChange(e.gridApi.grid,i.dataChange.COLUMN)},e.states={dateOnly:function(e){var t=e,s=[];return t&&(s=t.split(" ")),s[0]},timeOnly:function(e){var t=e,s=[];return t&&(s=t.split(" ")),s[1]},disconnectStatus:function(e){if(localStorage.session_key===e.entity.sessionKey){if(1!=confirm("You about to disconnect yourself from Strataware. Are you sure you wish to continue?"))return e.entity.checkOutStatus=0,!1;o.debug("You pressed OK!"),a(e),window.location="/"}else{if(confirm("You about to disconnect "+e.entity.userName+" from Strataware. Are you sure you wish to continue?")!==!0)return o.debug("You pressed Cancel!"),e.entity.checkOutStatus=0,!1;o.debug("You pressed OK!"),a(e)}},getTranslation:function(t){return e.pageTranslations[t]}},e.searchDates=function(){s.getAccessLedgerData(0,e.objAccessHistory.dateFrom,e.objAccessHistory.dateTo).then(function(t){e.gridOptions.data=t.accessHistoryDetails,e.objAccessHistory.dateFrom=t.checkinFromDate,e.objAccessHistory.dateTo=t.checkinToDate})},e.formatDate=function(t,s){if(t){var n,i=t.getFullYear(),o=t.getMonth()+1,a=t.getDate();parseInt(o,10)%10&&(o="0"+o),parseInt(a,10)%10&&(a="0"+a),n=a+"-"+o+"-"+i,s.value=n;var r=31536e6;if(new Date(e.objAccessHistory.dateFrom).getTime()+r<new Date(e.objAccessHistory.dateTo).getTime()){var c=new Date(new Date(e.objAccessHistory.dateFrom).getTime()+r);e.objAccessHistory.dateTo=c.getDate()+"-"+c.getMonth()+"-"+c.getFullYear()}if(e.objAccessHistory.dateFrom<=e.objAccessHistory.dateTo){var l=new Date(e.objAccessHistory.dateTo);l.setTime(l.getTime()+864e5)}}};var r='<div class="status_col ui-grid-cell-contents" ng-show="COL_FIELD == 0 && !clickedDisconnect">{{getExternalScopes().getTranslation("yes")}}</div><div class="status_col ui-grid-cell-contents " ng-show="COL_FIELD != 0 || clickedDisconnect">{{getExternalScopes().getTranslation("no")}}</div>',c='<div class="status_col ui-grid-cell-contents" ng-show="COL_FIELD == 0 && !clickedDisconnect"><a class="red" ng-click="getExternalScopes().disconnectStatus(row);">{{getExternalScopes().getTranslation("disconnect")}}</a></div>';e.gridOptions={useExternalFiltering:!0,enableFiltering:!0,enableColumnResizing:!0,paginationPageSizes:[50,100,150,200],paginationPageSize:50,enableGridMenu:!1,enableRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!1,exporterCsvFilename:"accessHistory.csv",exporterPdfDefaultStyle:{fontSize:9},exporterPdfTableStyle:{margin:[30,30,30,30]},exporterPdfTableHeaderStyle:{fontSize:10,bold:!0,italics:!0,color:"red"},exporterPdfHeader:{text:"Access History",style:"headerStyle"},exporterPdfCustomFormatter:function(e){return e.styles.headerStyle={fontSize:22,bold:!0},e.styles.footerStyle={fontSize:10,bold:!0},e},exporterPdfOrientation:"portrait",exporterPdfPageSize:"LETTER",exporterPdfMaxGridWidth:500,exporterCsvLinkElement:angular.element(document.querySelectorAll(".custom-csv-link-location")),columnDefs:[{field:"checkInDate",name:e.pageTranslations.login_date,visible:!e.exceptions.login_date,translationKey:"login_date"},{field:"checkInTime",name:e.pageTranslations.login_time,visible:!e.exceptions.login_time,translationKey:"login_time"},{field:"checkOutDate",name:e.pageTranslations.logout_date,visible:!e.exceptions.logout_date,translationKey:"logout_date"},{field:"checkOutTime",name:e.pageTranslations.logout_time,visible:!e.exceptions.logout_time,translationKey:"logout_time"},{field:"userName",name:e.pageTranslations.mfAccessLedgerUserName,visible:!e.exceptions.mfAccessLedgerUserName,translationKey:"mfAccessLedgerUserName"},{field:"browserInfo",name:e.pageTranslations.mfAccessLedgerBrowserInformation,visible:!e.exceptions.mfAccessLedgerBrowserInformation,translationKey:"mfAccessLedgerBrowserInformation"},{field:"ipAddress",name:e.pageTranslations.ip_address,visible:!e.exceptions.ip_address,translationKey:"login_time"},{field:"checkOutStatus",name:e.pageTranslations.mfAccessLedgerOnline,cellTemplate:r,visible:!e.exceptions.mfAccessLedgerOnline,translationKey:"mfAccessLedgerOnline",filter:{condition:function(e,t){return-1!=="yes".indexOf(e.toLowerCase())&&0===t?!0:-1!=="no".indexOf(e.toLowerCase())&&0!==t?!0:!1}}},{field:"checkOutStatus",name:"",cellTemplate:c,visible:!e.exceptions.mfAccessLedgerOnline,filter:{condition:function(e,t){return-1!=="yes".indexOf(e.toLowerCase())&&0===t?!0:-1!=="no".indexOf(e.toLowerCase())&&0!==t?!0:!1}}}],onRegisterApi:function(t){e.gridApi=t}},s.getAccessLedgerData(0,"2001-01-01 00:00:00","2001-01-01 00:00:00").then(function(t){e.gridOptions.data=[],e.gridOptions.data=t.accessHistoryDetails,e.objAccessHistory.dateFrom=t.checkinFromDate,e.objAccessHistory.dateTo=t.checkinToDate,e.gridApi.core.notifyDataChange(e.gridApi.grid,i.dataChange.COLUMN)}),e["export"]=function(t){if("csv"===t){var s=angular.element(document.querySelectorAll(".custom-csv-link-location"));e.gridApi.exporter.csvExport("all","all",s)}else"pdf"===t&&e.gridApi.exporter.pdfExport("all","all")},e.accessHistorySearch=function(){s.getAccessLedgerData(0,e.objAccessHistory.dateFrom,e.objAccessHistory.dateTo).then(function(t){e.gridOptions.data=t.accessHistoryDetails,e.gridApi.core.notifyDataChange(e.gridApi.grid,i.dataChange.COLUMN)})}}])});