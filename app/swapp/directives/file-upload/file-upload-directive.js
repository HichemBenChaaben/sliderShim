"use strict";define(["swapp"],function(e){e.registerDirective("swFileUpload",["$rootScope","$q",function(e,t){return{templateUrl:function(e,t){return t.path+"file-upload/file-upload-directive.tpl.html"},restrict:"E",replace:!0,scope:{},link:function(a,n,r){function i(e,t,a,n){return e>t&&e>a?(t=Math.round(t*=a/e),e=a):t>n&&(e=Math.round(e*=n/t),t=n),{width:e,height:t}}function o(e,t,a){var n=document.createElement("canvas"),r=n.getContext("2d"),o=i(e.width,e.height,t,a);return t=o.width,a=o.height,n.width=t,n.height=a,r.drawImage(e,0,0,t,a),n.toDataURL()}function d(e){e.stopPropagation(),e.preventDefault()}function c(e){e.stopPropagation(),e.preventDefault(),a.files.draggingOver=!0,a.$apply()}function l(e){e.stopPropagation(),e.preventDefault(),a.files.draggingOver=!1,a.$apply()}function s(t){t.stopPropagation(),t.preventDefault();var n=t.dataTransfer.files;f(n[0]).then(function(t){if(r.maxWidth||r.maxHeight){var n=new Image;n.src=t,t=o(n,r.maxWidth,r.maxHeight)}a.src=t;var i={name:r.name,base64:t};e.$broadcast("fileUploaded",i),a.justDroppedFile=!0},function(){e.$broadcast("fileUploadError")}),a.files.draggingOver=!1}a.files={},a.displayText=r.displayText,a.height=r.height||250,a.width=r.width||250,a.src=r.initSrc,a.path=r.path;var p=r.maxSize||1e6;a.$on("setFileSrc",function(e,t){t.name===r.name&&(a.src=t.base64)}),a.prefix=function(){return-1===a.src.indexOf("data:image/")&&-1===a.src.indexOf("http://")?"data:image/png;base64,":""};var f=function(e){var a=t.defer();if(e.size>p)a.reject(!1);else{var n=new FileReader;n.onload=function(e){a.resolve(e.target.result)},n.readAsDataURL(e)}return a.promise},u=n[0].children[1];u.ondragenter=c,u.ondragleave=l,u.ondragover=d,u.ondrop=s,a.addImage=function(){var e=new MouseEvent("click",{});n[0].children[0].dispatchEvent(e)},a.removeImage=function(){a.src=null;var t={name:r.name};e.$broadcast("fileDeleted",t)},n.bind("change",function(t){var n=t.target.files[0];n&&!a.justDroppedFile&&f(n).then(function(t){a.src=t;var n={name:r.name,base64:t};e.$broadcast("fileUploaded",n)},function(){e.$broadcast("fileUploadError")}),a.justDroppedFile=!1})}}}])});