define(["swapp","/swapp/directives/address-book/address-input-directive.js","/swapp/directives/address-book/address-book-directive.js","/swapp/directives/address/address-directives.js","/swapp/directives/file-upload/file-upload-directive.js","/swapp/factories/local-time.js","socket-factory","ui-bootstrap"],function(a){a.registerController("mfPropDetailsController",["$scope","$rootScope","socket","$timeout","localTimeFormat","gettextCatalog",function(a,t,e,r,s,o){a.propDetails={},a.translations={},a.permissions=a.$parent.modPermissions,a.pageTranslations=a.$parent.modTranslations,a.dateFormat=s.get(),a.exceptions=a.$parent.modExceptions,a.permissions=a.$parent.modPermissions;var i=!1;a.$on("selectedProperty",function(t,e){a.fetchPropDetails()}),a.$on("setModTranslations",function(t){a.translations=a.parseTranslationsData(a.$parent.modTranslations)}),a.tildeSeparator=function(a){var t=[];if(a)for(var e=a.split(";"),r=0;r<e.length;r++){var s=e[r].split("~");t.push({readable:s[0],value:s[1]})}return t},a.formatDate=function(a){return a?new Date(a).getTime():a},a.$on("fileUploaded",function(t,e){a.propDetails.digitalseal=e.base64,i=!0}),a.$on("fileDeleted",function(t,e){a.propDetails.digitalseal=null,i=!0}),a.$on("fileUploadError",function(){alertFactory.add("danger",a.translations.mfPropDetailsFileTooLarge,1e4)}),a.$on("selectedProperty",function(t,e){a.fetchPropDetails()}),a.$on("setModTranslations",function(t){a.translations=a.parseTranslationsData(a.$parent.modTranslations)}),a.tildeSeparator=function(a){var t=[];if(a)for(var e=a.split(";"),r=0;r<e.length;r++){var s=e[r].split("~");t.push({readable:s[0],value:s[1]})}return t},a.formatDate=function(a){return a?new Date(a).getTime():a},a.fetchPropDetails=function(){var s={task_request:"Property/getDetails",data:a.$parent.propertySelected.cts};e.get(s).then(function(e){e=angular.fromJson(e),e.CTS=parseInt(e.CTS,10),e.ABN=parseInt(e.ABN,10),e.AdjudiDate=a.formatDate(e.AdjudiDate),e.Audit_date=a.formatDate(e.Audit_date),e.latestplan=a.formatDate(e.latestplan),e.RegDate=a.formatDate(e.RegDate),e.creationdate=a.formatDate(e.creationdate),e.Update=a.formatDate(e.Update),a.originalDigitalSeal=e.digitalseal,"string"==typeof e.digitalseal&&0!==e.digitalseal.indexOf("data:")&&(e.digitalseal="data:image/jpg;base64,"+e.digitalseal),e.company=e.company?"company":"bodyCorporate",a.propDetails=e,e.array_to_json&&(a.propDetails.auditorname_1=e.array_to_json[0].cname),a.managerOptions=[e.username,e.firstname,e.lastname],t.$broadcast("setFileSrc",{name:"digitalSeal",base64:e.digitalseal}),r(function(){t.$broadcast("updateAddress",{pc:a.propDetails.Postcode,locality:a.propDetails.Suburb}),t.$broadcast("getRegionId",a.propDetails.region_name)})})},a.parseTranslationsData=function(t){return t&&(t.mfPropDetailsActList&&(t.mfPropDetailsActList=t.mfPropDetailsActList.split(";")),t.mfPropDetailsStrataTypeList&&(t.mfPropDetailsStrataTypeList=a.tildeSeparator(t.mfPropDetailsStrataTypeList)),t.mfPropDetailsPlanTypeList&&(t.mfPropDetailsPlanTypeList=a.tildeSeparator(t.mfPropDetailsPlanTypeList)),t.mfPropDetailsModuleList&&(t.mfPropDetailsModuleList=t.mfPropDetailsModuleList.split(";"))),t},a.fetchPropDetails(),a.translations=a.parseTranslationsData(a.$parent.modTranslations),a.formatDateForDatabase=function(a){if(a instanceof Date){var t=a.getMonth()+1;10>t&&(t="0"+t);var e=a.getDate();return 10>e&&(e="0"+e),a.getFullYear()+"-"+t+"-"+e+" 00:00:00"}var r=new Date(a);return r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" 00:00:00"},a.save=function(){var t=angular.copy(a.propDetails);if(t.array_to_json=null,t.creationdate=a.formatDateForDatabase(t.creationdate),t.RegDate=a.formatDateForDatabase(t.RegDate),t.Audit_date=a.formatDateForDatabase(t.Audit_date),t.latestplan=a.formatDateForDatabase(t.latestplan),t.AdjudiDate=a.formatDateForDatabase(t.AdjudiDate),t.Update=a.formatDateForDatabase(t.Update),t.company="company"===t.company?!0:!1,i){var r={task_request:"Property/setPropertySeal",data:{CTS:a.$parent.propertySelected.cts,property_seal_base64:t.digitalseal.replace(/(data).+;base64,/,"")}};e.get(r)}t.digitalseal=null;var r={task_request:"Property/setDetails",data:t};e.get(r).then(function(t){1===t.result?alertFactory.add("success",a.translations.saved,5e3):alertFactory.add("danger",a.translations.mfPropDetailsPropbemSaving,5e3)})}}])});